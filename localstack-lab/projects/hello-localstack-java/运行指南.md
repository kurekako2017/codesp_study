# LocalStack Java 程序运行指南

## 快速运行方法

### 方法 1: 在 IntelliJ IDEA 中运行 (推荐)

#### 步骤 1: 确保 LocalStack 正在运行
在 PowerShell 中运行：
```powershell
docker start localstack
docker ps | Select-String localstack
```

#### 步骤 2: 在 IDEA 中打开项目
1. 打开 IntelliJ IDEA
2. **File** → **Open**
3. 选择目录: `D:\dev\study\localstack-lab\projects\hello-localstack-java`
4. 等待 Maven 自动导入依赖

#### 步骤 3: 运行程序
**方式 A: 直接运行 main 方法**
1. 打开文件: `src/main/java/com/example/localstack/App.java`
2. 找到 `public static void main` 方法
3. 点击行号左侧的 **绿色运行按钮** ▶
4. 或右键 → **Run 'App.main()'**

**方式 B: 使用 Maven 插件**
1. 打开右侧 **Maven** 面板
2. 展开 **hello-localstack-java** → **Plugins** → **exec**
3. 双击 **exec:java**
4. 程序会在底部 **Run** 窗口显示输出

#### 步骤 4: 查看输出
程序会在 IDEA 底部的 **Run** 窗口显示类似以下内容：
```
Endpoint: http://s3.localhost.localstack.cloud:4566
Bucket: hello-localstack-java
Key: hello.txt
Content:
Hello LocalStack from Java! UTC now: 2026-01-01T14:30:45.123Z
```

---

### 方法 2: 使用命令行运行

#### PowerShell 脚本 (推荐)
```powershell
# 进入项目目录
cd D:\dev\study\localstack-lab\projects\hello-localstack-java

# 运行脚本
.\run.ps1
```

#### 手动命令
```powershell
# 1. 确保 LocalStack 运行
docker start localstack

# 2. 设置环境变量
$env:LOCALSTACK_ENDPOINT_URL = "http://localhost:4566"

# 3. 编译并运行
cd D:\dev\study\localstack-lab\projects\hello-localstack-java
mvn clean compile exec:java
```

#### 批处理文件
```cmd
cd D:\dev\study\localstack-lab\projects\hello-localstack-java
run.bat
```

---

### 方法 3: 编译后直接运行 JAR

```powershell
# 编译项目
mvn clean package

# 运行（需要配置 JAR with dependencies）
java -cp target/hello-localstack-java-0.1.0.jar com.example.localstack.App
```

---

## 程序功能说明

这个示例程序会：
1. ✓ 连接到本地 LocalStack (端口 4566)
2. ✓ 创建一个 S3 bucket: `hello-localstack-java`
3. ✓ 上传一个文件 `hello.txt` 到 bucket
4. ✓ 从 bucket 下载并读取文件内容
5. ✓ 打印结果到控制台

---

## 预期输出

### 成功运行时
```
[INFO] --- exec-maven-plugin:3.5.0:java (default-cli) @ hello-localstack-java ---
Endpoint: http://s3.localhost.localstack.cloud:4566
Bucket: hello-localstack-java
Key: hello.txt
Content:
Hello LocalStack from Java! UTC now: 2026-01-01T14:30:45.123456Z

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
```

### 如果 LocalStack 未运行
```
software.amazon.awssdk.core.exception.SdkClientException: 
Unable to execute HTTP request: Connect to localhost:4566 [localhost/127.0.0.1] failed
```

**解决方法**：
```powershell
docker start localstack
```

---

## 配置说明

### Endpoint 配置
程序默认使用环境变量 `LOCALSTACK_ENDPOINT_URL`，如果未设置则使用：
```
http://s3.localhost.localstack.cloud:4566
```

如果域名解析有问题，可以设置环境变量：
```powershell
$env:LOCALSTACK_ENDPOINT_URL = "http://localhost:4566"
```

或直接修改代码：
```java
String endpoint = "http://localhost:4566";
```

### Path-Style Access
代码中已配置：
```java
.serviceConfiguration(S3Configuration.builder()
    .pathStyleAccessEnabled(true)
    .build())
```
这样 S3 请求会使用 `http://localhost:4566/bucket-name/key` 格式，而不是虚拟主机格式。

---

## 查看 LocalStack 日志

程序运行时，可以在另一个终端窗口查看 LocalStack 处理请求的日志：

```powershell
# 实时查看
docker logs -f localstack

# 查看最近 50 行
docker logs localstack --tail 50
```

你会看到类似：
```
INFO  --- [   asgi_gw_0] localstack.request.aws     : AWS s3.CreateBucket => 200
INFO  --- [   asgi_gw_1] localstack.request.aws     : AWS s3.PutObject => 200
INFO  --- [   asgi_gw_2] localstack.request.aws     : AWS s3.GetObject => 200
```

---

## 验证结果

### 使用 AWS CLI (awslocal)
如果安装了 `awslocal`:
```powershell
# 列出所有 buckets
awslocal s3 ls

# 列出 bucket 中的对象
awslocal s3 ls s3://hello-localstack-java/

# 下载文件
awslocal s3 cp s3://hello-localstack-java/hello.txt -

# 输出: Hello LocalStack from Java! UTC now: ...
```

### 使用 LocalStack Web UI
1. 访问: https://app.localstack.cloud
2. 连接到本地实例: `http://localhost:4566`
3. 在 **S3** 服务中可以看到创建的 bucket 和文件

---

## 常见问题

### Q1: Maven 命令找不到
**检查安装**：
```powershell
mvn --version
```

**如果未安装**，参考文档: `WSL_JAVA_MAVEN_共通配置.md`

### Q2: Java 版本不匹配
项目需要 Java 11+:
```powershell
java --version
```

### Q3: 依赖下载失败
```powershell
# 清理并重新下载
mvn clean
mvn dependency:resolve
```

### Q4: LocalStack 连接超时
确认：
1. LocalStack 正在运行: `docker ps | Select-String localstack`
2. 端口 4566 未被占用
3. 防火墙未阻止连接

---

## 日志文件位置

### Java 应用日志
- **控制台输出**: 运行时在终端或 IDEA Run 窗口显示
- **保存日志**: 运行脚本会生成 `run-output.txt` 或 `output.log`

### LocalStack 日志
- **实时查看**: `docker logs -f localstack`
- **保存**: `docker logs localstack > localstack.log 2>&1`

详细说明参考: `如何查看LocalStack日志.md`

---

## 下一步

### 扩展示例 - DynamoDB
参考 `JAVA_QUICKSTART.md` 文档中的 DynamoDB 示例，创建新的 Java 类。

### 扩展示例 - SQS
参考文档创建 SQS 队列的 Java 示例。

### 集成到 JtProject
将 LocalStack 配置集成到 Spring Boot 项目中，参考 `JAVA_QUICKSTART.md` 的集成部分。

---

**创建时间**: 2026-01-01  
**项目位置**: `D:\dev\study\localstack-lab\projects\hello-localstack-java`  
**运行脚本**: `run.ps1` 或 `run.bat`

